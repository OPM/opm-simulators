# Pre-commit configuration for OPM Simulators
# This configuration uses the pre-commit framework to automatically format source files
# before commits, ensuring consistent code style across the project.
#
# Installation:
# -------------
# 1. Install pre-commit (choose one method):
#    - Via pip: pip install pre-commit
#    - Via conda: conda install -c conda-forge pre-commit
#    - Via homebrew (macOS): brew install pre-commit
#    - Via package manager (Ubuntu/Debian): apt install pre-commit
#
# 2. Install the hooks in your local repository:
#    pre-commit install
#
# Usage:
# ------
# - Hooks run automatically on every commit
# - To run manually on all files: pre-commit run --all-files
# - To run on specific files: pre-commit run --files <file1> <file2>
# - To skip hooks for a commit: git commit --no-verify
# - To update hook versions: pre-commit autoupdate
#
# What these hooks do:
# -------------------
# - trailing-whitespace: Removes trailing whitespace from lines
#   (preserves Markdown hard line breaks with --markdown-linebreak-ext=md)
# - end-of-file-fixer: Ensures files end with exactly one newline
# - git-clang-format-fix: Applies clang-format to staged C/C++/CUDA files (only the diff)
#
# Note:
# - The git-clang-format-fix hook will re-stage any changes it makes. After it runs, you will need to review the changes and re-run your commit.
# - The git-clang-format-fix can be disabled by setting SKIP=git-clang-format-fix=1 in your environment, eg. `SKIP=git-clang-format-fix=1 git commit -m "Your commit message"`

repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0  # Latest release as of August 2025
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        types_or: [c, c++, python, shell, yaml, cmake, markdown, text]
        exclude: '^(build/|\.git/)'

      - id: end-of-file-fixer
        types_or: [c, c++, python, shell, yaml, cmake, markdown, text]
        exclude: '^(build/|\.git/)'
  - repo: local
    hooks:
      - id: git-clang-format-fix
        name: git-clang-format (diff-only, auto-fix)
        entry: |
          bash -c '
            # First check if anything needs formatting
            if git clang-format --staged --diff --quiet; then
              # No changes needed
              exit 0
            fi

            echo "[git-clang-format] Applying formatting to staged changes..."
            git clang-format --staged
            # Re-add anything the formatter touched
            git add -A

            echo
            echo "[git-clang-format] Changes have been applied."
            echo "Please review and re-run your commit."
            echo
            # Force user to re-run commit so they see the changes
            exit 1
          '
        language: system
        types_or: [c++, c, cuda]
        pass_filenames: false
